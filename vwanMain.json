{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "type": "string",
      "metadata":{
        "description": "Specify the location for the resources."
      }
    },
    "vwanResourceGroup": {
      "type": "string",
      "metadata": {
          "description": "Name of the VWAN resource group."
      }
    },
    "vwanName": {
      "type": "string",
      "metadata": {
          "description": "Name of the Virtual Wan."
      }
    },
    "vwanSku": {
      "type": "string",
      "metadata": {
          "description": "Sku of the Virtual Wan."
      },
      "allowedValues": [
          "Standard",
          "Basic"
      ]
    },
    "hubName": {
      "type": "string",
      "metadata": {
          "description": "Name of the Virtual Hub. A virtual hub is created inside a virtual wan."
      }
    },
    "hubAddressPrefix": {
      "type": "string",
      "metadata": {
          "description": "The hub address prefix. This address prefix will be used as the address prefix for the hub vnet"
      }
    },
    "commonSubId": {
      "type": "string",
      "metadata": {
          "description": "Subscription ID of the common subscription"
      }
    },
    "managementSubId": {
      "type": "string",
      "metadata": {
          "description": "Subscription ID of the management subscription"
      }
    },
    "securitySubId": {
      "type": "string",
      "metadata": {
          "description": "Subscription ID of the security subscription"
      }
    },
    "identitySubId": {
      "type": "string",
      "metadata": {
          "description": "Subscription ID of the identity subscription"
      }
    },
    "devopsSubId": {
      "type": "string",
      "metadata": {
          "description": "Subscription ID of the devops subscription"
      }
    },
    "commonVnetResourceGroup": {
      "type": "string",
      "metadata": {
          "description": "Name of the Common vnet resource group."
      }
    },
    "managementVnetResourceGroup": {
      "type": "string",
      "metadata": {
          "description": "Name of the Management vnet resource group."
      }
    },
    "securityVnetResourceGroup": {
      "type": "string",
      "metadata": {
          "description": "Name of the Security vnet resource group."
      }
    },
    "identityVnetResourceGroup": {
      "type": "string",
      "metadata": {
          "description": "Name of the Identity vnet resource group."
      }
    },
    "devopsVnetResourceGroup": {
      "type": "string",
      "metadata": {
          "description": "Name of the Devops vnet resource group."
      }
    },
    
    "commonVnetName": {
      "type": "string",
      "metadata": {
        "description": "Common VNet name"
      }
    },
    "commonVnetAddressPrefix": {
      "type": "string",
      "metadata": {
        "description": "Common Address prefix"
      }
    },
    "commonCmpeSnCidr": {
      "type": "string",
      "metadata": {
        "description": "Common CMPE sn Cidr"
      }
    },
    "commonSnowMidsSnCidr": {
      "type": "string",
      "metadata": {
        "description": "Common SNOW Mid Servers sn Cidr"
      }
    },
    "commonGhRunnersSnCidr": {
      "type": "string",
      "metadata": {
        "description": "Common GH Runners sn Cidr"
      }
    },
    "commonNsgName": {
      "type": "string",
      "metadata": {
        "description": "Common NSG Name"
      }
    },
    "managementVnetName": {
      "type": "string",
      "metadata": {
        "description": "Management VNet name"
      }
    },
    "managementVnetAddressPrefix": {
      "type": "string",
      "metadata": {
        "description": "Management Address prefix"
      }
    },
    "managementSubnet1Prefix": {
      "type": "string",
      "metadata": {
        "description": "Management Subnet 1 Prefix"
      }
    },
    "managementSubnet1Name": {
      "type": "string",
      "metadata": {
        "description": "ManagementSubnet 1 Name"
      }
    },
    "securityVnetName": {
      "type": "string",
      "metadata": {
        "description": "Security VNet name"
      }
    },
    "securityVnetAddressPrefix": {
      "type": "string",
      "metadata": {
        "description": "Security Address prefix"
      }
    },
    "securitySubnet1Prefix": {
      "type": "string",
      "metadata": {
        "description": "Security Subnet 1 Prefix"
      }
    },
    "securitySubnet1Name": {
      "type": "string",
      "metadata": {
        "description": "Security subnet 1 Name"
      }
    },
    "identityVnetName": {
      "type": "string",
      "metadata": {
        "description": "Identity VNet name"
      }
    },
    "identityVnetCidr": {
      "type": "string",
      "metadata": {
        "description": "Identity VNet Cidr"
      }
    },
    "dnsServers": {
      "type": "array",
      "metadata": {
        "description": "Identity Dns Servers"
      }
    },
    "identityBastionSnCidr": {
      "type": "string",
      "metadata": {
        "description": "Identity bastion sn Cidr"
      }
    },
    "identityAdSnCidr": {
      "type": "string",
      "metadata": {
        "description": "Identity AD sn Cidr"
      }
    },
    "identityPamSnCidr": {
      "type": "string",
      "metadata": {
        "description": "Identity PAM sn Cidr"
      }
    },
    "identitySailpointSnCidr": {
      "type": "string",
      "metadata": {
        "description": "Identity Sailpoint sn Cidr"
      }
    },
    "identityNsgName": {
      "type": "string",
      "metadata": {
        "description": "Identity NSG Name"
      }
    },
    "devopsVnetName": {
      "type": "string",
      "metadata": {
        "description": "Devops VNet name"
      }
    },
    "devopsVnetAddressPrefix": {
      "type": "string",
      "metadata": {
        "description": "Devops Address prefix"
      }
    },
    "devopsSubnet1Prefix": {
      "type": "string",
      "metadata": {
        "description": "Devops Subnet 1 Prefix"
      }
    },
    "devopsSubnet1Name": {
      "type": "string",
      "metadata": {
        "description": "Devops subnet 1 Name"
      }
    }
  },
  "variables": {
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2020-06-01",
      "name": "[parameters('vwanResourceGroup')]",
      "location": "[parameters('location')]",
      "tags": {
        "Note": "subscription level deployment"
      },
      "properties": {}
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "commonVnetRgDeployment",
      "subscriptionId": "[parameters('commonSubId')]",
      "location": "[parameters('location')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/dylanx77/az-nested/main/rgLinked.json",
          "contentVersion":"1.0.0.0"
        },
        "parameters": {
          "rgName": {
            "value": "[parameters('commonVnetResourceGroup')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "managementVnetRgDeployment",
      "subscriptionId": "[parameters('managementSubId')]",
      "location": "[parameters('location')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/dylanx77/az-nested/main/rgLinked.json",
          "contentVersion":"1.0.0.0"
        },
        "parameters": {
          "rgName": {
            "value": "[parameters('managementVnetResourceGroup')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "securityVnetRgDeployment",
      "subscriptionId": "[parameters('securitySubId')]",
      "location": "[parameters('location')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/dylanx77/az-nested/main/rgLinked.json",
          "contentVersion":"1.0.0.0"
        },
        "parameters": {
          "rgName": {
            "value": "[parameters('securityVnetResourceGroup')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "identityVnetRgDeployment",
      "subscriptionId": "[parameters('identitySubId')]",
      "location": "[parameters('location')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/dylanx77/az-nested/main/rgLinked.json",
          "contentVersion":"1.0.0.0"
        },
        "parameters": {
          "rgName": {
            "value": "[parameters('identityVnetResourceGroup')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "devopsVnetRgDeployment",
      "subscriptionId": "[parameters('devopsSubId')]",
      "location": "[parameters('location')]",
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/dylanx77/az-nested/main/rgLinked.json",
          "contentVersion":"1.0.0.0"
        },
        "parameters": {
          "rgName": {
            "value": "[parameters('devopsVnetResourceGroup')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "vwanDeployment",
      "resourceGroup": "[parameters('vwanResourceGroup')]",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/resourceGroups/', parameters('vwanResourceGroup'))]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/dylanx77/az-nested/main/vwanLinked.json",
          "contentVersion":"1.0.0.0"
        },
        "parameters": {
          "vwanName": {
            "value": "[parameters('vwanName')]"
          },
          "vwanSku": {
            "value": "[parameters('vwanSku')]"
          },
          "hubName": {
            "value": "[parameters('hubName')]"
          },
          "hubAddressPrefix": {
            "value": "[parameters('hubAddressPrefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "commonVnetDeployment",
      "resourceGroup": "[parameters('commonVnetResourceGroup')]",
      "dependsOn": [
        "commonVnetRgDeployment"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/dylanx77/az-nested/main/vnetCommon.json",
          "contentVersion":"1.0.0.0"
        },
        "parameters": {
          "networkSecurityGroupName": {
            "value": "[parameters('commonNsgName')]"
          },
          "vnetName": {
            "value": "[parameters('commonVnetName')]"
          },
          "vnetCidr": {
            "value": "[parameters('commonVnetAddressPrefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "cmpeSnCidr": {
            "value": "[parameters('commonCmpeSnCidr')]"
          },
          "snowMidsSnCidr": {
            "value": "[parameters('commonSnowMidsSnCidr')]"
          },
          "ghRunnersSnCidr": {
            "value": "[parameters('commonGhRunnersSnCidr')]"
          },
          "dnsServers": {
            "value": "[parameters('dnsServers')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "managementVnetDeployment",
      "resourceGroup": "[parameters('managementVnetResourceGroup')]",
      "dependsOn": [
        "managementVnetRgDeployment"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/dylanx77/az-nested/main/vnetSingleSubnetLinked.json",
          "contentVersion":"1.0.0.0"
        },
        "parameters": {
          "vnetName": {
            "value": "[parameters('managementVnetName')]"
          },
          "vnetAddressPrefix": {
            "value": "[parameters('managementVnetAddressPrefix')]"
          },
          "subnet1Name": {
            "value": "[parameters('managementSubnet1Name')]"
          },
          "subnet1Prefix": {
            "value": "[parameters('managementSubnet1Prefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "securityVnetDeployment",
      "resourceGroup": "[parameters('securityVnetResourceGroup')]",
      "dependsOn": [
        "securityVnetRgDeployment"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/dylanx77/az-nested/main/vnetSingleSubnetLinked.json",
          "contentVersion":"1.0.0.0"
        },
        "parameters": {
          "vnetName": {
            "value": "[parameters('securityVnetName')]"
          },
          "vnetAddressPrefix": {
            "value": "[parameters('securityVnetAddressPrefix')]"
          },
          "subnet1Name": {
            "value": "[parameters('securitySubnet1Name')]"
          },
          "subnet1Prefix": {
            "value": "[parameters('securitySubnet1Prefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "IdentityVnetDeployment",
      "resourceGroup": "[parameters('identityVnetResourceGroup')]",
      "dependsOn": [
        "identityVnetRgDeployment"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/dylanx77/az-nested/main/vnetIdentity.json",
          "contentVersion":"1.0.0.0"
        },
        "parameters": {
          "networkSecurityGroupName": {
            "value": "[parameters('identityNsgName')]"
          },
          "vnetName": {
            "value": "[parameters('identityVnetName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "vnetCidr": {
            "value": "[parameters('identityVnetCidr')]"
          },
          "dnsServers": {
            "value": "[parameters('dnsServers')]"
          },
          "bastionSnCidr": {
            "value": "[parameters('identityBastionSnCidr')]"
          },
          "adSnCidr": {
            "value": "[parameters('identityAdSnCidr')]"
          },
          "pamSnCidr": {
            "value": "[parameters('identityPamSnCidr')]"
          },
          "sailpointSnCidr": {
            "value": "[parameters('identitySailpointSnCidr')]"
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-06-01",
      "name": "devopsVnetDeployment",
      "resourceGroup": "[parameters('devopsVnetResourceGroup')]",
      "dependsOn": [
        "devopsVnetRgDeployment"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "https://raw.githubusercontent.com/dylanx77/az-nested/main/vnetSingleSubnetLinked.json",
          "contentVersion":"1.0.0.0"
        },
        "parameters": {
          "vnetName": {
            "value": "[parameters('devopsVnetName')]"
          },
          "vnetAddressPrefix": {
            "value": "[parameters('devopsVnetAddressPrefix')]"
          },
          "subnet1Name": {
            "value": "[parameters('devopsSubnet1Name')]"
          },
          "subnet1Prefix": {
            "value": "[parameters('devopsSubnet1Prefix')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        }
      }
    }
  ]
}